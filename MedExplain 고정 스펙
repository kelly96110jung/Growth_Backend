# MedExplain 프로젝트 고정 스펙 v3 (최종)

> 졸업프로젝트용 · 스펙 고정(Frozen)  
> 상용화 목적 ❌ (약관 동의 기반 사용)

---

## 0. 기본 전제

- Google **Streaming Recognize** 사용
- 서버가 **스트리밍 세션 직접 관리**
- **Gemini API Key** 사용
- 상용화 목적 ❌  
  - 전사/변환 결과 저장은 허용
  - 약관 동의 기반 사용

---

## 1. 대상 / 사용자 / 진료과

### 1차 진료과
- 성형외과 (Plastic Surgery)

### 사용자
- 성형외과 진료를 받는 일반 환자
- 외국인 환자 (영어 / 중국어)
- 의료 통역사 보조 용도 사용자

---

## 2. 시간 / 성능 / 녹음 규칙

### 상담 시간
- 기본: **5분**
- 최대: **20분**

### 스트리밍 세그먼트 관리
- Streaming 방식 사용
- 내부 처리 기준:
  - **30초 내외 ~ 최대 1분 단위 세그먼트**로 관리

### 성능 목표
- 결과 표시 목표: **5초 이내**
- 최소 요구 사항:
  - **출력 1(원문 전사)** 은 5초 이내 화면 표시

---

## 3. 출력 정의 (고정)

### 출력 1 – 원문 전사
- Streaming STT 결과
- **Interim(부분 전사)** / **Final(확정 전사)** 구분
- 언어 그대로 표시  
  - ko / en / zh 혼용 가능

---

### 출력 2 – 변환본 (1차 필수 구성)

#### 번역
- 1차 범위:
  - **의사 한국어 → 환자 English / Chinese**

#### 용어 글로스
- 사전 기반 용어 매칭
- 원문 병기
- **의학용어는 번역하지 않음**
  - 의미는 별도 카드 UI로 제공

#### 모르는 / 불확실한 용어 처리
- 사전에 없거나 확신 없는 용어:
  - **빨간색 표시**
  - 라벨: `확인 필요`

---

## 4. 모드 설계

### 모드 A – 환자 이해 모드
**입력**
- 의사 한국어 (+ 영문 의학용어)

**출력 2**
- 용어 글로스
- (확장 슬롯)
  - 쉬운 말 설명
  - 요약

---

### 모드 B – 외국인 의사소통 모드 (1차 확정)
**방향**
- 의사 ko → 환자 en / zh

**출력 2**
- 번역문
- 용어 글로스
- 빨간색 `확인 필요` 용어 표시

---

## 5. 품질 정책 (절대 규칙)

- **정확도 > 안정성 > 자연스러움**
- 확실하지 않은 경우:
  - 억지 번역 ❌
  - 경고 표시 + 원문 유지 ⭕️

---

## 6. 스트리밍 + 세션 운영 규칙 (서버 세션 관리형)

### 세션 규칙
- 최대 세션 시간: **20분**
- 세그먼트 단위 누적 관리

### 네트워크 재시도
- 스트리밍 중 연결 끊김 발생 시:
  - 서버가 세션 유지
  - 자동 재시도 수행

### UI 상태 표시
- `연결 끊김 → 재연결 중 (1/3)`

### 재시도 실패 시
- 해당 세그먼트:
  - 전사 불완전 처리
  - `warnings` 항목에 기록

---

## 7. 전체 아키텍처 (확정)

### 7.1 구성 요소

#### 1) Flutter App
- 마이크 입력
- 오디오 스트림 생성 및 전송
- 출력 1 / 출력 2 UI 렌더링
- Interim / Final 전사 상태 표시

#### 2) MedExplain Server
- 스트리밍 세션 생성 및 관리
- Google STT Streaming 연결
- 세그먼트 단위 전사 누적 관리
- 사전 기반 의학 용어 매칭
- 번역 파이프라인 (ko → en / zh)
- Gemini API 확장 슬롯 처리

#### 3) 응답 이벤트
- `stt_interim` : 부분 전사 결과
- `stt_final` : 확정 전사 결과
- `transform_ready` : 번역 / 용어 변환 결과
- `warning` : 전사 불완전, 불확실 용어, 네트워크 이슈

---

### 7.2 데이터 흐름

1. Flutter App이 세션 시작 요청 전송  
2. 서버가 스트리밍 STT 세션 생성  
3. Flutter App이 오디오 스트림 청크 전송  
4. 서버가 Google STT Streaming으로 전달  
5. 서버가 Interim / Final 전사 이벤트 수신  
6. 사전 기반 용어 매칭 및 번역 처리  
7. `stt_interim`, `stt_final`, `transform_ready` 이벤트를 앱으로 전달  
8. 앱에서 출력 1 / 출력 2 UI 업데이트

---

### 7.3 스트리밍 중 예외 처리

- 네트워크 연결 끊김 발생 시:
  - 서버가 세션 상태 유지
  - 자동 재연결 시도
- 재연결 실패 시:
  - 해당 세그먼트 전사 불완전 처리
  - `warning` 이벤트로 클라이언트 전달
